{"id":994,"date":"2023-01-23T10:38:53","date_gmt":"2023-01-23T10:38:53","guid":{"rendered":"http:\/\/malwr0nwind0z.local\/post_1-23-23_asyncrat_sample_part_2\/"},"modified":"2023-02-28T05:35:28","modified_gmt":"2023-02-28T05:35:28","slug":"post_1-23-23_asyncrat_sample_part_2","status":"publish","type":"post","link":"http:\/\/malwr0nwind0z.local\/post_1-23-23_asyncrat_sample_part_2\/","title":{"rendered":"ASyncRAT delivered through malspam via OneNote attachment (Stage 2)"},"content":{"rendered":"<p>Continuing our previous AsyncRAT discussion, this is Part 2 of this blog post, where I will review stage 2, which will cover the analysis of the ASyncRAT payload (payload.exe) and we will dive into some of its functionalities.<\/p>\n<p style=\"text-align: center;\"><strong><img decoding=\"async\" class=\"aligncenter\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/payload_CFF.png\" alt=\"\" width=\"619\" height=\"628\" \/>\u00a0<\/strong><strong style=\"font-style: inherit; color: var(--ast-global-color-3); background-color: var(--ast-global-color-5);\">Figure 1: File property details of payload.exe shown in CFF Explorer.<\/strong><\/p>\n<p>Unpacking ASyncRAT<\/p>\n<p>Since this is a .NET Assembly executable, I used DnSpy to start debugging it, to try and determine what are some of this file\u2019s functionalities. After analyzing and decrypting the encoded (Base64 + AES Encryption (Key, IV)) 1st function (Fig. 2), this malware utilizes some of the following Anti-analysis Techniques:<\/p>\n<p>Calls <em>CheckRemoteDebuggerPresent<\/em> which checks if a debugger (in a different process on the same machine) is attached to the current process.<\/p>\n<p>Calls <em>IsDebuggerPresent<\/em> which checks whether the current process is being debugged by a user-mode debugger.<\/p>\n<p>Calls <em>AmsiScanBuffer <\/em>to attempt to bypass AMSI (Antimalware Scan Interface).<\/p>\n<p><strong><img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/payload_1st_funct_cmd_choice__del.png\" alt=\"\" width=\"1901\" height=\"705\" \/><\/strong> <strong>Figure 2: The first function of payload.exe while loaded into DnSpy. <\/strong><\/p>\n<p><strong><img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/cyberchef_decode_strings_payload_1st_funct_cmd_choice__del.png\" alt=\"\" width=\"1094\" height=\"574\" \/><br \/>\nFigure 3: De-obfuscating the first function using CyberChef, reveals strings of Anti-analysis API calls.<\/strong><\/p>\n<p>Looking at all of the obfuscation within each of these functions, I came to the conclusion, that I was looking at a packed file.<\/p>\n<p>My next step was to look for the file\u2019s unpacking routine, which brought me to the object named memoryStream2 which is from the MemoryStream Class where it receives decompressed bytes from object GzipStream. These bytes were copied to _buffer. After my breakpoint is hit at \u201creturn memoryStream2.ToArray()\u201d. I was able to dump the contents of _buffer, the dumped binary is an executable (File header: MZ). (Fig. 4 &amp; 5)<\/p>\n<p><strong><img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/dnspy_breakpoint_dump.png\" alt=\"\" width=\"1402\" height=\"1000\" \/>Figure 4: Breakpoint set on \u201creturn memoryStream2.ToArray()\u201d, contents of _buffer is a dumped executable (File header: 0x4D5A).<br \/>\n<\/strong><\/p>\n<p><strong><img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/dnspy_memory_dump_unpack.png\" alt=\"\" width=\"1575\" height=\"654\" \/> Figure 5: MemoryDump Window 2 shows contents of _buffer which is a dumped executable (File header: MZ).<\/strong><\/p>\n<p>A quick look at this file in CFF Explorer (Fig. 6). I can confirm after reviewing its strings, that the dumped binary is an unpacked version of ASyncRAT. I re-named this file unpacked_payload.exe (Original Filename: AsyncClientnownow.exe).<\/p>\n<p><img decoding=\"async\" class=\"aligncenter\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/unpacked_payload_CFF.png\" alt=\"\" width=\"596\" height=\"606\" \/><strong>Figure 6: File property details of unpacked_payload.exe (AsyncClientnownow.exe) shown in CFF Explorer.<\/strong><\/p>\n<p>Analysis of unpacked ASyncRaT<\/p>\n<p>Next, I load unpacked_payload.exe (AsyncClientnownow.exe) into DnSpy for analysis. The Main() function initializes settings and flow of code execution. The delay function defines the sleep duration (3 seconds) before execution.<\/p>\n<p>Mutex<\/p>\n<p>if (!MutexControl.CreateMutex())<\/p>\n<p>Environment.Exit(0);<\/p>\n<p>It checks to make sure that the current payload is not duplicated by checking if the Mutex value already exist (MTX = &#8220;AsyncMutex_6SI8OkPnk&#8221;). (Figure 7).<\/p>\n<p>InitializeSettings<\/p>\n<p>if (!Settings.InitializeSettings())<\/p>\n<p>Environment.Exit(0);<\/p>\n<p>The InitializeSettings function enables all hardcoded configurations and settings (Fig. 7). It also enables decryption of all configuration settings from the AES256 algorithm. (Fig. 8).<\/p>\n<p style=\"text-align: center;\"><img decoding=\"async\" class=\"aligncenter\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/Main_funct_intialization.png\" alt=\"\" width=\"750\" height=\"998\" \/><strong style=\"font-style: inherit; background-color: var(--ast-global-color-5); color: var(--ast-global-color-3);\">Figure 7: Main() function.<\/strong><\/p>\n<pre><\/pre>\n<p><strong><img decoding=\"async\" class=\"alignnone size-full wp-image-1023\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/01\/Settings_funct.png\" alt=\"\" width=\"1033\" height=\"1789\" srcset=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/01\/Settings_funct.png 1033w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/01\/Settings_funct-173x300.png 173w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/01\/Settings_funct-591x1024.png 591w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/01\/Settings_funct-768x1330.png 768w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/01\/Settings_funct-887x1536.png 887w\" sizes=\"(max-width: 1033px) 100vw, 1033px\" \/>Figure 8: InitializeSettings function, where you can see the decryption of all configuration settings from the AES256 algorithm.<\/strong><\/p>\n<p>Configuration Settings<\/p>\n<p>Below are the decrypted hardcoded configuration settings:<\/p>\n<p><em>Key: JXkxqn0C8WXhwunn5UZ2PfINpI6joafo <\/em><\/p>\n<p><em>Ports: 6606, 7707, 8808 <\/em><\/p>\n<p><em>Hosts: 154.12.234.207 <\/em><\/p>\n<p><em>Version: 0.5.7B <\/em><\/p>\n<p><em>Install: False <\/em><\/p>\n<p><em>MTX (Mutex): AsyncMutex_6SI8OkPnk <\/em><\/p>\n<p><em>Pastebin: null <\/em><\/p>\n<p><em>Anti: False <\/em><\/p>\n<p><em>BDOS: False<\/em><\/p>\n<p><strong><img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/payload_traffic_154.12.234.207.png\" alt=\"\" width=\"1873\" height=\"107\" \/><br \/>\nFigure 9: Connection to C2 server (154.12.234.207) to check-in.<\/strong><\/p>\n<p>Anti Analysis<\/p>\n<p>The Anti Analysis function includes multiple subfunctions to check for the following anti-analysis tools such as (Fig. 10):<\/p>\n<ul>\n<li>Detect Manufacturer: enables anti-VM (virtual machine) techniques by using WMI to check for VM environments by querying for the following keywords: \u201cMicrosoft Corporation\u201d, \u201cVIRTUAL\u201d, \u201cVMware\u201d, or \u201cVirtualBox\u201d.<\/li>\n<li>Detect Sandbox: checks for the presence of \u201cSbieDll.dll\u201d, to detect if it is running in a sandbox (Sandboxie).<\/li>\n<li>IsSmallDisk: checks for small disk less (than or equal to 61000000000L\u00a0(56.8 GB)) that may be often used by virtual machines designed for malware analysis.<\/li>\n<li>IsXP: checks whether the operating system is Windows XP.<\/li>\n<li>Anti-Virus Check: checks for which antivirus product is installed in the system by using WMI query command:\u00a0\u201c<a href=\"&quot;file:\/\/\/\\rootSecurityCenter2&quot;\"><strong>\\rootSecurityCenter2<\/strong><\/a><strong>\u201d<\/strong>. This pulls this information from Windows security Center.<\/li>\n<li>Detect Debugger: calls <em>CheckRemoteDebuggerPresent<\/em> which checks if a debugger (in a different process on the same machine) is attached to the current process.<\/li>\n<\/ul>\n<p><img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/Anti-analysis_funct.png\" alt=\"\" width=\"760\" height=\"1773\" \/><strong>Figure 10: Anti_Analysis function.<\/strong><\/p>\n<p>Install and Persistence<\/p>\n<p>ASyncRAT\u2019s Install function maintains persistence checks as to whether the user has admin privileges. This occurs by creating a scheduled task to check every time a user logs on (Fig. 11):<\/p>\n<p><strong>\u201c\/<\/strong>c schtasks \/create \/f \/sc onlogon \/rl highest \/tn\u201d<\/p>\n<p>If the process reveals there are no admin privileges, a run registry entry is created in HKEY_CURRENT_USER:\u00a0\u201cSoftware\\Microsoft\\Windows\\CurrentVersion\\Run\u201d;\u00a0it then copies itself into a\u00a0\u201c%temp%\u201d\u00a0folder with a different name and executes from the temp folder via a batch script (Fig. 12 &amp;13).<\/p>\n<p><img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/install_funct.png\" alt=\"\" width=\"997\" height=\"1735\" \/><strong>Figure 11: Install function.<\/strong><\/p>\n<p style=\"text-align: center;\"><img decoding=\"async\" class=\"aligncenter\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/cleanup.png\" alt=\"\" width=\"455\" height=\"129\" \/><strong>Figure 12: Batch script used for Persistence.<\/strong><\/p>\n<p><strong> <img decoding=\"async\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/02\/run_key_persistance.png\" alt=\"\" width=\"1304\" height=\"235\" \/><br \/>\nFigure 13: Registry key used for Persistence.<\/strong><\/p>\n<p>From there, the attacker can execute various commands on the infected system, including:<\/p>\n<p>\u2022 Downloading additional malware (i.e. Remos)<\/p>\n<p>\u2022 Executing programs and commands<\/p>\n<p>\u2022 Taking screenshots<\/p>\n<p>\u2022 Logging keystrokes<\/p>\n<p>\u2022 Turning on the microphone and\/or webcam to spy on the victim<\/p>\n<p>Detection and Prevention<\/p>\n<p>To detect and prevent ASyncRat attacks, it is important to be aware of the following:<\/p>\n<p>\u2022 Suspicious email attachments<\/p>\n<p>\u2022 Suspicious network activity<\/p>\n<p>\u2022 Slow system performance<\/p>\n<p>\u2022 Unusual pop-up windows and error messages<\/p>\n<p>It is also recommended to implement the following best practices:<\/p>\n<p>\u2022 Keep software and security systems up to date<\/p>\n<p>\u2022 Educate employees on the dangers of phishing emails and malspam<\/p>\n<p>\u2022 Use Anti-Virus with real-time protection<\/p>\n<p>\u2022 Enable firewalls and limit incoming connections<\/p>\n<p>\u2022 Regularly backup important data and store those backups offline<\/p>\n<p>Conclusion<\/p>\n<p>ASyncRat is a malicious RAT that can compromise the security of a target system and allow remote attackers to gain unauthorized access and control. To protect against ASyncRat attacks, it is important to be aware of the signs of infection and implement best practices for cybersecurity. By staying informed and vigilant, organizations and individuals can reduce their risk of falling victim to ASyncRat.<\/p>\n<p>IOCs:<\/p>\n<p>payload.exe (Original Filename: tmp4D28.tmp) (MD5: FCF99858964E59B68B0433B135B499BB)<\/p>\n<p>unpacked_payload.exe (AsyncClientnownow.exe) (MD5: e9d6d1ed7007d55c6a9ec576ff1f0172)<\/p>\n<p>C2 IOCs:<\/p>\n<p>154.12.234[.]207 (wormxwar.ddns[.]net, quasharr.ddns[.]net)<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Continuing our previous AsyncRAT discussion, this is Part 2 of this blog post, where I will review stage 2, which will cover the analysis of the ASyncRAT payload (payload.exe) and we will dive into some of its functionalities. \u00a0Figure 1: File property details of payload.exe shown in CFF Explorer. Unpacking ASyncRAT Since this is a &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"\" href=\"http:\/\/malwr0nwind0z.local\/post_1-23-23_asyncrat_sample_part_2\/\"> <span class=\"screen-reader-text\">ASyncRAT delivered through malspam via OneNote attachment (Stage 2)<\/span> Read More &raquo;<\/a><\/p>\n","protected":false},"author":1,"featured_media":930,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-global-header-display":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"default","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":""},"categories":[4],"tags":[12,14,15,13],"aioseo_notices":[],"_links":{"self":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts\/994"}],"collection":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/comments?post=994"}],"version-history":[{"count":17,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts\/994\/revisions"}],"predecessor-version":[{"id":1027,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts\/994\/revisions\/1027"}],"wp:featuredmedia":[{"embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/media\/930"}],"wp:attachment":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/media?parent=994"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/categories?post=994"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/tags?post=994"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}