{"id":1220,"date":"2023-10-23T16:21:31","date_gmt":"2023-10-23T16:21:31","guid":{"rendered":"https:\/\/malwr0nwind0z.com\/?p=1220"},"modified":"2024-01-29T01:34:09","modified_gmt":"2024-01-29T01:34:09","slug":"post_10-23-23_living_off_the_land_pentest","status":"publish","type":"post","link":"https:\/\/malwr0nwind0z.com\/post_10-23-23_living_off_the_land_pentest\/","title":{"rendered":"The Ultimate Test: Living Off the Land (LOTL) while Rick Rollin"},"content":{"rendered":"\n<figure class=\"wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio\"><div class=\"wp-block-embed__wrapper\">\n<div class=\"ast-oembed-container \" style=\"height: 100%;\"><iframe title=\"LOLbins: Living Off the Land while Rick Rollin\" width=\"500\" height=\"281\" src=\"https:\/\/www.youtube.com\/embed\/YEPOBSatNgA?feature=oembed\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen><\/iframe><\/div>\n<\/div><figcaption class=\"wp-element-caption\"><strong>Video 1: Watch the companion video that this blog post inspired.<\/strong><\/figcaption><\/figure>\n\n\n\n<p><\/p>\n\n\n<p>I recently conducted a pentesting exercise for one of my clients. One main focus of the exercise was to detect and prevent a &#8220;Living off the Land&#8221; (LOTL) attack.<\/p>\n<p>&#8220;Living off the Land&#8221; (LOTL) in the context of cybersecurity refers to a technique used by hackers to carry out attacks using tools and utilities that are already<\/p>\n<p>present on a compromised system or network. Instead of relying on downloading malicious software, cybercriminals exploit legitimate programs and scripts to evade detection.<\/p>\n<p>In LOTL attacks, hackers use built-in operating system tools, scripting languages, and other software commonly found on computers to conduct malicious activities. This method makes it challenging for traditional security solutions to detect the attack, as the tools being used are not inherently malicious.<\/p>\n<p>LOTL attacks can involve activities such as executing PowerShell scripts, using Windows Management Instrumentation (WMI), employing Batch or Shell scripts, and leveraging legitimate administration tools like PsExec. By using these tools, hackers can move laterally across a network, escalate privileges, exfiltrate data, and perform other malicious actions without raising suspicion.<\/p>\n<p>Common LOTL programs and libraries exploited by threat actors include:<\/p>\n<ul>\n<li>powershell.exe<\/li>\n<li>psexec.exe<\/li>\n<li>bitsadmin.exe<\/li>\n<li>regsvr32.exe<\/li>\n<li>certutil.exe<\/li>\n<li>wmic.exe<\/li>\n<li>mshta.exe<\/li>\n<li>mofcomp.exe<\/li>\n<li>cmstp.exe<\/li>\n<li>windbg.exe<\/li>\n<li>cdb.exe<\/li>\n<li>msbuild.exe<\/li>\n<li>csc.exe<\/li>\n<\/ul>\n<p>In this test scenario, I sent a malspam email with an attached zip file that contained a batch script (Past_Due_Invoice.pdf.bat) once the user clicked on the batch script, the cmd.exe (Parent process) is used to run the batch file (Past_Due_Invoice.pdf.bat) that ultimately downloads and runs a PowerShell script(past_due_invoice.pdf.ps1).<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-screenshot-of-a-computer-description-automatica.png\" alt=\"A screenshot of a computer\nDescription automatically generated\" \/><\/p>\n<p><strong>Figure 1: Malspam contained a batch script within a zip archive named Past_Due_Invoice.pdf.zip.<\/strong><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-screenshot-of-a-computer-program-description-au.png\" alt=\"A screenshot of a computer program\nDescription automatically generated\" \/><strong><a id=\"post-1220-_Hlk148928289\"><\/a><br \/>Figure 2: This batch file (Past_Due_Invoice.pdf.bat) that ultimately downloads and runs a PowerShell script(past_due_invoice.pdf.ps1).<\/strong><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-screenshot-of-a-computer-description-automatica-1.png\" alt=\"A screenshot of a computer\nDescription automatically generated\" \/><br \/><strong>Figure 3: The PowerShell script (past_due_invoice.pdf.ps1) is dropped in the Temp folder.<\/strong><\/p>\n<p>This PowerShell script\u2019s 1<sup>st<\/sup> code block checks if the script is running in a PowerShell environment other than the interactive console (&#8220;ConsoleHost&#8221;). If it is not the console host, it starts a new PowerShell process, downloads a script from a specified URL (<a href=\"http:\/\/bit.ly\/e0Mw9w\">http:\/\/bit.ly\/e0Mw9w<\/a> un-shortened to https:\/\/www.leeholmes[.]com\/projects\/ps_html5\/Invoke-PSHtml5.ps1) and executes it. If it is running in the console host, the script simply terminates without performing any additional actions.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-screen-shot-of-a-computer-description-automatic.png\" alt=\"A screen shot of a computer\nDescription automatically generated\" \/><a id=\"post-1220-_Hlk148928660\"><\/a><strong>Figure 4: See the encoded Base64 string ($data).<\/strong><\/p>\n<p>This 2<sup>nd<\/sup> code block takes the Base64 encoded string ($data), decodes it, decompresses the binary data using GZip compression (decompresses it), interprets the resulting data as PowerShell code, and then executes it.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-screenshot-of-a-computer-program-description-au-1.png\" alt=\"A screenshot of a computer program\nDescription automatically generated\" \/><strong><a id=\"post-1220-_Hlk148928877\"><\/a><br \/>Figure 5: The encoded Base64 is decoded, then decompressed using GZip.<\/strong><\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-screenshot-of-a-computer-description-automatica-2.png\" alt=\"A screenshot of a computer\nDescription automatically generated\" \/><br \/><strong>Figure 6: Cyberchef recipe: \u201cFrom Base64\u201d and \u201cGunZip\u201d.<\/strong><\/p>\n<p>The decoded and decompress Base64 string code has a variable named $frames.<\/p>\n<p>The 3rd code block loops through the current frame(s) in the $frames array and is stored in the $frame variable. It generates an expansion string by arranging random elements (&#8216;$1&#8217;, &#8216;$2&#8217;, and &#8216;$3&#8217;) in a specific pattern. The frame is split into individual parts using tab as the separator. Certain groups of characters within each part are replaced with the generated expansion string. The modified parts are joined back together into a frame using tabs. The modified frame is stored back into the original array. This effectively changes the proper aspect ratio in the PowerShell window, that gives the animation (Rick Roll) movement.<\/p>\n<p>The last code block that I will discuss in this script. Opens and plays a Media Player\u00a0mp3 file in the background, which is downloaded from <a href=\"http:\/\/www.leeholmes.com\/projects\/ps_html5\/background.mp3\">http:\/\/www.leeholmes.com\/projects\/ps_html5\/background.mp3<\/a> while the animated Rick Roll runs in the foreground.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-screenshot-of-a-computer-program-description-au-2.png\" alt=\"A screenshot of a computer program\nDescription automatically generated\" \/><br \/><strong>Figure 7: This code block runs through its main loop. Then downloads and plays a classic pop song.<\/strong><\/p>\n<p>This PowerShell script ultimately is an automated version of the Rick Roll meme (Rick Astley &#8211; Never Gonna Give You Up). Created by PowerShell Developer Lee Holmes.<\/p>\n<p><img decoding=\"async\" src=\"https:\/\/malwr0nwind0z.com\/wp-content\/uploads\/2023\/10\/a-black-background-with-a-black-square-descriptio.gif\" alt=\"A black background with a black square\nDescription automatically generated with medium confidence\" \/><br \/><strong>GIF 1: Automated version of the Rick Roll meme (Rick Astley &#8211; Never Gonna Give You Up).<\/strong><\/p>\n<p>In summary, &#8220;Living off the Land&#8221; attacks involve hackers utilizing existing, legitimate software and tools on a compromised system to carry out cyber attacks, making it harder for security measures to identify and prevent these malicious activities.<\/p>\n<p><strong>File Indicators:<\/strong><\/p>\n<p>Past_Due_Invoice.pdf.bat (MD5: 9AAEDA5770ADD96EEC1183F964FFA238) Classification: LOL-test-joke-not malicious.<\/p>\n<p>past_due_invoice.pdf.ps1 (MD5: 0D94AF018D0C6EEE1D66F6AC19BE1EED) Classification: LOL-pentest-joke-not malicious.<\/p>\n<p>background.mp3 (MD5: D17433016E273F1525C10469A08820DE) Classification: benign mp3 file (Rick Astley &#8211; Never Gonna Give You Up).<\/p>\n<p><a id=\"post-1220-_Hlk148045553\"><\/a><strong>Network Indicators (URLs):<\/strong><\/p>\n<p><a href=\"http:\/\/bit.ly\/e0Mw9w\">http:\/\/bit.ly\/e0Mw9w<\/a><\/p>\n<p>https:\/\/www.leeholmes.com\/projects\/ps_html5\/Invoke-PSHtml5.ps1<\/p>\n<p><a href=\"https:\/\/www.leeholmes.com\/projects\/ps_html5\/background.mp3\">https:\/\/www.leeholmes.com\/projects\/ps_html5\/background.mp3<\/a><\/p>\n<p><strong>References:<\/strong> https:\/\/www.leeholmes.com\/powershell-and-html5\/<\/p>","protected":false},"excerpt":{"rendered":"<p>I recently conducted a pentesting exercise for one of my clients. One main focus of the exercise was to detect and prevent a &#8220;Living off the Land&#8221; (LOTL) attack. &#8220;Living off the Land&#8221; (LOTL) in the context of cybersecurity refers to a technique used by hackers to carry out attacks using tools and utilities that [&hellip;]<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"om_disable_all_campaigns":false,"_monsterinsights_skip_tracking":false,"_monsterinsights_sitenote_active":false,"_monsterinsights_sitenote_note":"","_monsterinsights_sitenote_category":0,"site-sidebar-layout":"default","site-content-layout":"","ast-site-content-layout":"default","site-content-style":"default","site-sidebar-style":"default","ast-global-header-display":"","ast-banner-title-visibility":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","astra-migrate-meta-layouts":"set","ast-page-background-enabled":"default","ast-page-background-meta":{"desktop":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"tablet":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"mobile":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""}},"ast-content-background-meta":{"desktop":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"tablet":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"mobile":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""}},"footnotes":""},"categories":[45],"tags":[59,61,60,55,68,51,58,52,69,49,85,66,63,62,57,53,54,56,87,64,50,100],"aioseo_notices":[],"_links":{"self":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts\/1220"}],"collection":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/comments?post=1220"}],"version-history":[{"count":13,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts\/1220\/revisions"}],"predecessor-version":[{"id":1279,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/posts\/1220\/revisions\/1279"}],"wp:attachment":[{"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/media?parent=1220"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/categories?post=1220"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/malwr0nwind0z.com\/wp-json\/wp\/v2\/tags?post=1220"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}