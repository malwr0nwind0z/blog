{"id":1165,"date":"2023-07-26T00:34:40","date_gmt":"2023-07-26T00:34:40","guid":{"rendered":"https:\/\/malwr0nwind0z.com\/?p=1165"},"modified":"2023-07-26T13:38:53","modified_gmt":"2023-07-26T13:38:53","slug":"post_7-25-23_network_forensics_agent_tesla","status":"publish","type":"post","link":"http:\/\/malwr0nwind0z.local\/post_7-25-23_network_forensics_agent_tesla\/","title":{"rendered":"Network Forensics with Wireshark and Brim: Analyzing a PCAP from an Agent Tesla infection"},"content":{"rendered":"<p><img decoding=\"async\" loading=\"lazy\" width=\"623\" height=\"155\" class=\"wp-image-1169\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-close-up-of-a-logo-description-automatically-ge.jpeg\" alt=\"A close up of a logo\n\nDescription automatically generated\" srcset=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-close-up-of-a-logo-description-automatically-ge.jpeg 623w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-close-up-of-a-logo-description-automatically-ge-300x75.jpeg 300w\" sizes=\"(max-width: 623px) 100vw, 623px\" \/><\/p>\n<h4>Simplifying Network Forensic Analysis: Exploring Wireshark PCAP Files with Brim<\/h4>\n<p>Wireshark is a powerful network protocol analyzer that allows network administrators and security professionals to monitor and inspect network traffic. It captures packets in real-time or reads from existing capture files, known as PCAP files, for offline analysis. However, as the complexity of network data increases, analyzing PCAP files can become cumbersome. In this blog post, we&#8217;ll introduce Brim, a modern and intuitive tool that simplifies the process of viewing and analyzing Wireshark PCAP files, making network analysis more efficient and insightful.<\/p>\n<p><strong>Understanding PCAP Files<\/strong><\/p>\n<p>A PCAP (Packet Capture) file is a data file that contains captured network packets in a standardized format. Wireshark generates these files when capturing live traffic or when reading from previously recorded sessions. PCAP files store packet information, including source and destination IP addresses, ports, protocols, timestamps, and more. These files are invaluable for diagnosing network issues, detecting anomalies, and investigating security incidents.<\/p>\n<p><strong>Introducing Brim<\/strong><\/p>\n<p>Brim is a state-of-the-art network analysis tool designed to help users make sense of vast amounts of network data, including Wireshark PCAP files. It provides an elegant and user-friendly interface that simplifies the process of exploring complex network datasets. Brim&#8217;s unique approach combines speed, scalability, and advanced search capabilities, making it an excellent choice for both novices and experienced analysts.<\/p>\n<p><strong>Key Features of Brim:<\/strong><\/p>\n<p>Intuitive Interface: Brim&#8217;s interface is designed with the user in mind. The clean and modern layout allows for easy navigation and efficient analysis, eliminating the steep learning curve associated with many network analysis tools.<\/p>\n<p>High Performance: Brim leverages cutting-edge technologies to handle large PCAP files with lightning-fast speed. Analyzing massive datasets is no longer a time-consuming task.<\/p>\n<p>Timeline View: Brim offers a timeline view that allows users to visualize network events over time. This feature helps in identifying patterns, understanding traffic trends, and spotting irregularities.<\/p>\n<p>Dynamic Filtering: Brim&#8217;s filtering capabilities are second to none. Users can quickly narrow down their searches using various criteria, such as IP addresses, ports, protocols, and timestamps.<\/p>\n<p>Advanced Query Language: Brim incorporates an expressive query language that enables users to create complex searches and analyze data with precision.<\/p>\n<p>Later, we will run Wireshark to collect network traffic in a Sandbox (Windows 10) Lab machine with the goal of analyzing any network connections made from a known Agent Tesla sample.<\/p>\n<p><strong>Agent Tesla: The RAT<\/strong><\/p>\n<p>Agent Tesla&#8221; is known as a type of Remote Access Trojan (RAT). A RAT is a malicious software program used by cybercriminals to gain unauthorized access and control over a victim&#8217;s computer remotely. Once installed on a target system, a RAT allows the attacker to perform various malicious activities, such as stealing sensitive information, logging keystrokes, capturing screenshots, accessing files, and even controlling the victim&#8217;s computer. The RAT&#8217;s primary purpose is to gather and exfiltrate valuable information from infected systems, which can then be used for various malicious purposes, such as identity theft, financial fraud, or selling the stolen data on the dark web.<\/p>\n<p><strong>How This Agent Tesla malware is delivered<\/strong><\/p>\n<p>Agent Tesla is typically delivered to the victim through various methods, including phishing emails, malspam, and exploit kits. The exact method of delivery may vary depending on the attackers&#8217; goals.<\/p>\n<p>In this instance, one of my customers received this malware through malspam; which contained a malicious .exe file (Agent Tesla) within a tar.gz archive named TT remittance against outstanding invoice.tar.gz. The malicious executable file (TT remittance against outstanding invoice.exe), that once clicked, it runs and executes.<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" width=\"1013\" height=\"285\" class=\"wp-image-1170\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica.jpeg\" alt=\"A screenshot of a computer\n\nDescription automatically generated\" srcset=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica.jpeg 1013w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-300x84.jpeg 300w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-768x216.jpeg 768w\" sizes=\"(max-width: 1013px) 100vw, 1013px\" \/> <strong>Figure 1: Malspam which contained a malicious .exe file (Agent Tesla) within a tar.gz archive named TT remittance against outstanding invoice.tar.gz<\/strong><\/p>\n<p><strong>Agent Tesla \u2013 Data Exfiltration over SMTP<\/strong><\/p>\n<p>I reviewed the post infection traffic from this malware using Wireshark and Brim. The review of the Wireshark capture reveals a DNS request for smtp.marintravellft.com. This was the start data exfiltration over SMTP.<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" width=\"1893\" height=\"43\" class=\"wp-image-1171\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/word-image-1165-3.png\" srcset=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/word-image-1165-3.png 1893w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/word-image-1165-3-300x7.png 300w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/word-image-1165-3-1024x23.png 1024w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/word-image-1165-3-768x17.png 768w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/word-image-1165-3-1536x35.png 1536w\" sizes=\"(max-width: 1893px) 100vw, 1893px\" \/><strong>Figure 2: Wireshark capture of C2 traffic show a DNS request to smtp.marintravellft.com.<\/strong><\/p>\n<p>Next, I seen successful authentication to a compromised email address (schayer@marintravellft.com). The body of the email shows that customer data is being exfiltrated, which includes the hostname, ip address, and username of the infected host machine.<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" width=\"1920\" height=\"652\" class=\"wp-image-1172\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica.png\" alt=\"A screenshot of a computer\n\nDescription automatically generated\" srcset=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica.png 1920w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-300x102.png 300w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-1024x348.png 1024w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-768x261.png 768w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-1536x522.png 1536w\" sizes=\"(max-width: 1920px) 100vw, 1920px\" \/><strong>Figure 3: Wireshark capture of C2 Traffic showing a successful connection over SMTP.<\/strong><\/p>\n<p>.<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" width=\"1280\" height=\"909\" class=\"wp-image-1173\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-1.png\" alt=\"A screenshot of a computer\n\nDescription automatically generated\" srcset=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-1.png 1280w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-1-300x213.png 300w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-1-1024x727.png 1024w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-1-768x545.png 768w\" sizes=\"(max-width: 1280px) 100vw, 1280px\" \/><strong>Figure 4: Wireshark capture of C2 traffic showing customer data being sent to a compromised email address (schayer@marintravellft.com).<\/strong><\/p>\n<p><strong>Agent Tesla \u2013 Exfiltration detected by Brim\u2019s Suricata<\/strong><\/p>\n<p>Lastly, I loaded the Wireshark PCAP file into Brim. Brim\u2019s Suricata signatures were able to detect and alert on the C2 connection to IP 208.91.199.224:58, which is the data exfiltration over SMTP.<\/p>\n<p><img decoding=\"async\" loading=\"lazy\" width=\"1918\" height=\"1031\" class=\"wp-image-1174\" src=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-2.png\" alt=\"A screenshot of a computer\n\nDescription automatically generated\" srcset=\"http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-2.png 1918w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-2-300x161.png 300w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-2-1024x550.png 1024w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-2-768x413.png 768w, http:\/\/malwr0nwind0z.local\/wp-content\/uploads\/2023\/07\/a-screenshot-of-a-computer-description-automatica-2-1536x826.png 1536w\" sizes=\"(max-width: 1918px) 100vw, 1918px\" \/><strong>Figure 5: Brim\u2019s Suricata engine detects the data exfiltration over SMTP.<\/strong><\/p>\n<p>That ends this blog, where we used Wireshark and Brim to collect and analyze network traffic from stage 1 of this Agent Tesla infection.<\/p>\n<p><strong>IOCs:<\/strong><\/p>\n<p>TT remittance against outstanding invoice.tar.gz (MD5: 3f2deec2e3e8871ec4d0e2c68fc81804)<\/p>\n<p>TT remittance against outstanding invoice.exe (MD5: e636239783988acde754d1555dcd1986)<\/p>\n<p><strong>C2 IOCs:<\/strong><\/p>\n<p>smtp.marintravellft.com<\/p>\n<p>us2.smtp.mailhostbox.com<\/p>\n<p>208.91.199.224:587<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Simplifying Network Forensic Analysis: Exploring Wireshark PCAP Files with Brim Wireshark is a powerful network protocol analyzer that allows network administrators and security professionals to monitor and inspect network traffic. It captures packets in real-time or reads from existing capture files, known as PCAP files, for offline analysis. However, as the complexity of network data &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"\" href=\"http:\/\/malwr0nwind0z.local\/post_7-25-23_network_forensics_agent_tesla\/\"> <span class=\"screen-reader-text\">Network Forensics with Wireshark and Brim: Analyzing a PCAP from an Agent Tesla infection<\/span> Read More &raquo;<\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"om_disable_all_campaigns":false,"_mi_skip_tracking":false,"_monsterinsights_sitenote_active":false,"_monsterinsights_sitenote_note":"","_monsterinsights_sitenote_category":0,"site-sidebar-layout":"default","site-content-layout":"","ast-site-content-layout":"","site-content-style":"default","site-sidebar-style":"default","ast-global-header-display":"","ast-banner-title-visibility":"","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":"","astra-migrate-meta-layouts":"","ast-page-background-enabled":"default","ast-page-background-meta":{"desktop":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"tablet":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"mobile":{"background-color":"","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""}},"ast-content-background-meta":{"desktop":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"tablet":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""},"mobile":{"background-color":"var(--ast-global-color-5)","background-image":"","background-repeat":"repeat","background-position":"center center","background-size":"auto","background-attachment":"scroll","background-type":"","background-media":"","overlay-type":"","overlay-color":"","overlay-gradient":""}},"footnotes":""},"categories":[16],"tags":[34,33,36,22,23,25,14,41,32,37,39,40,35],"aioseo_notices":[],"_links":{"self":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts\/1165"}],"collection":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/comments?post=1165"}],"version-history":[{"count":10,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts\/1165\/revisions"}],"predecessor-version":[{"id":1185,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/posts\/1165\/revisions\/1185"}],"wp:attachment":[{"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/media?parent=1165"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/categories?post=1165"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/malwr0nwind0z.local\/wp-json\/wp\/v2\/tags?post=1165"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}